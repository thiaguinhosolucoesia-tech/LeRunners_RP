const App = {
    state: { 
        userId: null,
        db: null,
        displayedDate: new Date(), 
        isEditing: true, 
        inventory: {} 
    },
    elements: {},

    init(user, firestoreInstance) {
        // Esconde o ecr√£ de carregamento e mostra a aplica√ß√£o
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('app-container').classList.remove('hidden');

        // Armazena o ID do utilizador e a inst√¢ncia da base de dados
        this.state.userId = user.uid;
        this.state.db = firestoreInstance;
        document.getElementById('userEmail').textContent = user.email;

        // Mapeia os elementos do DOM
        this.elements = {
            logoutButton: document.getElementById('logout-button'),
            userEmail: document.getElementById('userEmail'),
            currentDateDisplay: document.getElementById('currentDateDisplay'), prevDayBtn: document.getElementById('prevDayBtn'),
            nextDayBtn: document.getElementById('nextDayBtn'),
            planningFieldset: document.getElementById('planningFieldset'), reviewFieldset: document.getElementById('reviewFieldset'),
            endDayBtn: document.getElementById('endDayBtn'), dailyFocus: document.getElementById('dailyFocus'),
            criticalTasks: document.getElementById('criticalTasks'), todoList: document.getElementById('todo-list'),
            newTodoInput: document.getElementById('new-todo-input'), addTodoBtn: document.getElementById('add-todo-btn'),
            mainAchievement: document.getElementById('mainAchievement'), mainChallenge: document.getElementById('mainChallenge'),
            kpiMatriculas: document.getElementById('kpiMatriculas'), kpiCancelamentos: document.getElementById('kpiCancelamentos'),
            energyLevel: document.getElementById('energyLevel'), actionBankContent: document.getElementById('actionBank-content'),
            weeklySummarySection: document.getElementById('weeklySummarySection'), weeklySummaryContent: document.getElementById('weeklySummaryContent'),
            showWeeklySummaryBtn: document.getElementById('showWeeklySummaryBtn'),
            materialSelect: document.getElementById('materialSelect'), materialQty: document.getElementById('materialQty'),
            addStockBtn: document.getElementById('addStockBtn'), removeStockBtn: document.getElementById('removeStockBtn'),
            inventoryTbody: document.getElementById('inventory-tbody'),
            uploadFileBtn: document.getElementById('uploadFileBtn')
        };

        // Inicia as funcionalidades
        this.populateActionBank();
        this.populateMaterialSelect();
        this.addEventListeners();
        this.loadInventory();
        this.renderDay(this.getDateString(this.state.displayedDate));
    },
    
    getDocRef(collection, docId) {
        if (!this.state.userId) return null;
        return this.state.db.collection('gestores').doc(this.state.userId).collection(collection).doc(docId);
    },

    getDateString: date => date.toISOString().split('T')[0],
    parseDateString: str => new Date(str + 'T12:00:00Z'),
    
    async fetchData(collection, docId) {
        const docRef = this.getDocRef(collection, docId);
        if (!docRef) return null;
        const doc = await docRef.get();
        return doc.exists ? doc.data() : null;
    },

    async saveData(collection, docId, data) {
        const docRef = this.getDocRef(collection, docId);
        if (docRef) await docRef.set(data, { merge: true });
    },

    async renderDay(dateString) {
        this.state.displayedDate = this.parseDateString(dateString);
        this.elements.currentDateDisplay.textContent = this.state.displayedDate.toLocaleDateString('pt-BR', { dateStyle: 'full' });
        const data = await this.fetchData('diario', dateString);
        const ddb = data?.diarioDeBordo || {};
        this.elements.dailyFocus.value = ddb.dailyFocus || '';
        this.elements.criticalTasks.value = ddb.criticalTasks || '';
        this.elements.mainAchievement.value = ddb.mainAchievement || '';
        this.elements.mainChallenge.value = ddb.mainChallenge || '';
        this.elements.kpiMatriculas.value = ddb.kpiMatriculas || 0;
        this.elements.kpiCancelamentos.value = ddb.kpiCancelamentos || 0;
        this.elements.energyLevel.value = ddb.energyLevel || 3;
        this.elements.todoList.innerHTML = '';
        (ddb.todo || []).forEach(task => this.createTodoElement(task));
        this.state.isEditing = !ddb.isFinalized;
        this.toggleFieldsDisabled();
    },

    toggleFieldsDisabled() {
        const isDisabled = !this.state.isEditing;
        this.elements.planningFieldset.disabled = isDisabled;
        this.elements.reviewFieldset.disabled = isDisabled;
        const lockMessage = document.getElementById('lockMessage');
        if (lockMessage) { lockMessage.remove(); }
        if (isDisabled) {
            this.elements.endDayBtn.textContent = 'Editar Dia';
            this.elements.endDayBtn.classList.add('edit-mode');
            const messageDiv = document.createElement('div');
            messageDiv.id = 'lockMessage';
            messageDiv.style.textAlign = 'center';
            messageDiv.style.padding = '10px';
            messageDiv.style.backgroundColor = 'var(--light-blue)';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.marginTop = '20px';
            messageDiv.style.fontWeight = 'bold';
            messageDiv.innerHTML = `üîí Este dia foi finalizado. Clique em "Editar Dia" para fazer altera√ß√µes.`;
            this.elements.endDayBtn.parentElement.insertAdjacentElement('afterend', messageDiv);
        } else {
            this.elements.endDayBtn.textContent = 'Analisar e Finalizar Dia';
            this.elements.endDayBtn.classList.remove('edit-mode');
        }
    },

    addEventListeners() {
        this.elements.logoutButton.addEventListener('click', () => firebase.auth().signOut());
        this.elements.prevDayBtn.addEventListener('click', () => this.navigateDays(-1));
        this.elements.nextDayBtn.addEventListener('click', () => this.navigateDays(1));
        this.elements.addTodoBtn.addEventListener('click', () => this.addTodoItem());
        this.elements.endDayBtn.addEventListener('click', () => this.handleFinalizeDay());
        this.elements.showWeeklySummaryBtn.addEventListener('click', () => this.generateWeeklyAnalysis());
        this.elements.addStockBtn.addEventListener('click', () => this.updateStock('add'));
        this.elements.removeStockBtn.addEventListener('click', () => this.updateStock('remove'));
        this.elements.uploadFileBtn.addEventListener('click', () => this.openUploadWidget());
        this.elements.userEmail.addEventListener('click', () => this.promptForReset());
        this.elements.userEmail.style.cursor = 'pointer';
        this.elements.userEmail.title = 'Clique para op√ß√µes de sistema';
    },
    
    promptForReset() {
        const code = prompt("Para aceder √†s op√ß√µes de sistema, digite o c√≥digo de seguran√ßa:");
        if (code === '*177') {
            const confirmation = prompt("ATEN√á√ÉO: A√á√ÉO IRREVERS√çVEL!\nIsto ir√° apagar TODOS os seus di√°rios e o seu invent√°rio para SEMPRE.\n\nPara confirmar, digite 'APAGAR TUDO' e clique em OK.");
            if (confirmation === 'APAGAR TUDO') {
                this.hardResetUserData();
            } else {
                alert("Opera√ß√£o de reset cancelada.");
            }
        } else if (code !== null) {
            alert("C√≥digo incorreto.");
        }
    },

    async hardResetUserData() {
        alert("A iniciar o reset completo do sistema. A p√°gina ser√° recarregada ao concluir.");
        try {
            const deleteCollection = async (collectionPath) => {
                const querySnapshot = await this.state.db.collection(collectionPath).get();
                if (querySnapshot.empty) return;
                const batch = this.state.db.batch();
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
            };
            await deleteCollection(`gestores/${this.state.userId}/diario`);
            await deleteCollection(`gestores/${this.state.userId}/inventario`);
            alert("Sistema resetado com sucesso.");
            location.reload();
        } catch (error) {
            alert("Ocorreu um erro ao tentar resetar o sistema.");
        }
    },
    
    navigateDays(direction) {
        this.state.displayedDate.setDate(this.state.displayedDate.getDate() + direction);
        this.renderDay(this.getDateString(this.state.displayedDate));
    },

    addTodoItem(text = null) {
        const taskText = text || this.elements.newTodoInput.value.trim();
        if (taskText) {
            this.createTodoElement({ text: taskText, completed: false });
        }
        if(!text) {
            this.elements.newTodoInput.value = '';
        }
    },

    createTodoElement(task) {
        const li = document.createElement('li');
        li.innerHTML = `<input type="checkbox" ${task.completed ? 'checked' : ''}><span>${task.text}</span><button class="delete-todo-btn">&times;</button>`;
        li.querySelector('.delete-todo-btn').onclick = () => li.remove();
        this.elements.todoList.appendChild(li);
    },

    collectUIData() {
        return {
            dailyFocus: this.elements.dailyFocus.value, criticalTasks: this.elements.criticalTasks.value,
            mainAchievement: this.elements.mainAchievement.value, mainChallenge: this.elements.mainChallenge.value,
            kpiMatriculas: this.elements.kpiMatriculas.value, kpiCancelamentos: this.elements.kpiCancelamentos.value,
            energyLevel: this.elements.energyLevel.value,
            todo: Array.from(this.elements.todoList.querySelectorAll('li')).map(li => ({ text: li.querySelector('span').textContent, completed: li.querySelector('input').checked })),
        };
    },

    async handleFinalizeDay() {
        if (this.state.isEditing) {
            if (!confirm("Tem certeza que deseja finalizar o dia?")) return;
            const dataToSave = this.collectUIData();
            dataToSave.isFinalized = true;
            await this.saveData('diario', this.getDateString(this.state.displayedDate), { diarioDeBordo: dataToSave });
            const pendingTasks = dataToSave.todo.filter(t => !t.completed);
            if (pendingTasks.length > 0) {
                const nextDay = new Date(this.state.displayedDate);
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayString = this.getDateString(nextDay);
                const nextDayData = (await this.fetchData('diario', nextDayString)) || { diarioDeBordo: { todo: [] } };
                const tasksToCarryOver = pendingTasks.map(t => ({ text: `[ADIADO] ${t.text}`, completed: false }));
                nextDayData.diarioDeBordo.todo = [...tasksToCarryOver, ...(nextDayData.diarioDeBordo.todo || [])];
                await this.saveData('diario', nextDayString, nextDayData);
            }
            this.navigateDays(1);
        } else {
            this.state.isEditing = true;
            const data = await this.fetchData('diario', this.getDateString(this.state.displayedDate));
            if(data?.diarioDeBordo) {
                data.diarioDeBordo.isFinalized = false;
                await this.saveData('diario', this.getDateString(this.state.displayedDate), data);
            }
            this.toggleFieldsDisabled();
        }
    },
    
    async generateWeeklyAnalysis() {
        this.elements.weeklySummarySection.style.display = 'block';
        let analysisText = `An√°lise de Performance (Consultor Estrat√©gico)\n=================================================\n\n`;
        let weeklyData = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date(this.state.displayedDate); date.setDate(date.getDate() - i);
            const data = await this.fetchData('diario', this.getDateString(date));
            if (data?.diarioDeBordo) weeklyData.push(data.diarioDeBordo);
        }
        if (weeklyData.length === 0) { analysisText += "N√£o h√° dados para an√°lise."; } 
        else {
            const totalMatriculas = weeklyData.reduce((acc, d) => acc + Number(d.kpiMatriculas || 0), 0);
            const totalCancelamentos = weeklyData.reduce((acc, d) => acc + Number(d.kpiCancelamentos || 0), 0);
            const avgEnergy = weeklyData.reduce((acc, d) => acc + Number(d.energyLevel || 0), 0) / weeklyData.length;
            analysisText += `DIAGN√ìSTICO GERAL:\n- Saldo de Alunos: ${totalMatriculas - totalCancelamentos} (Mat: ${totalMatriculas}, Canc: ${totalCancelamentos})\n- N√≠vel de Energia M√©dio: ${avgEnergy.toFixed(1)}/5\n\n`;
            analysisText += `AN√ÅLISE ESTRAT√âGICA:\n`;
            if ((totalMatriculas - totalCancelamentos) < 0) { analysisText += `‚Ä¢ ALERTA DE RETEN√á√ÉO: O saldo negativo √© um sinal cr√≠tico de evas√£o.\n`; }
            else { analysisText += `‚Ä¢ MOMENTUM DE CAPTA√á√ÉO: O saldo positivo indica que as estrat√©gias de marketing est√£o a funcionar.\n`; }
            if (avgEnergy < 2.8) { analysisText += `‚Ä¢ RISCO DE BURNOUT: A energia baixa da equipa afeta a qualidade e a reten√ß√£o.\n`; }
        }
        this.elements.weeklySummaryContent.textContent = analysisText;
        this.elements.weeklySummarySection.scrollIntoView({ behavior: 'smooth' });
    },

    populateActionBank() {
        const actions = {
            "üß† An√°lise Pedag√≥gica Individual": [ "Identificar 3 alunos 'Longo Prazo' (acima de 2 anos) e agendar 'Reuni√£o de Metas' com os pais.", "Revisar o tempo de conclus√£o dos blocos de 5 alunos em est√°gio inicial. Est√£o demasiado r√°pidos ou lentos?", "Analisar as pastas de 3 alunos que apresentaram erros de repeti√ß√£o e planear uma orienta√ß√£o individual.", "Verificar a programa√ß√£o de material de 5 alunos pr√≥ximos a mudarem de est√°gio." ],
            "üë®‚Äçüë©‚Äçüëß Comunica√ß√£o com os Pais": [ "Ligar para 2 pais de alunos novos (menos de 3 meses) apenas para dar um feedback positivo e perguntar como est√° a rotina em casa.", "Enviar um e-mail para a base de pais com um artigo sobre a import√¢ncia da 'tarefa de casa bem feita'.", "Identificar um aluno com dificuldade e agendar uma reuni√£o de alinhamento com os pais, j√° com um plano de a√ß√£o em m√£os.", "Preparar e enviar o 'Boletim de Desempenho Mensal' para os alunos do Est√°gio G em diante." ],
            "ü§ù Gest√£o da Equipe e Treinamento": [ "Realizar um minitreinamento de 10 min sobre a 'Import√¢ncia do Elogio' durante a corre√ß√£o.", "Observar por 15 minutos a intera√ß√£o de um auxiliar com os alunos e preparar um feedback construtivo.", "Delegar a tarefa de organiza√ß√£o do estoque de blocos para um membro da equipa.", "Verificar se todos os treinamentos online obrigat√≥rios da franquia est√£o em dia para toda a equipa." ],
            "üè¢ Processos e Ambiente da Unidade": [ "Auditar o estoque dos 5 est√°gios mais comuns (ex: Mat. 4A, D, G; Port. AI, F) e verificar o ponto de pedido.", "Cronometrar o tempo m√©dio de atendimento na rece√ß√£o em hor√°rio de pico para identificar gargalos.", "Verificar a limpeza e organiza√ß√£o da 'Sala dos Pais' ou √°rea de espera.", "Checar o funcionamento de todos os equipamentos (tablets, cron√≥metros, ar condicionado)." ],
            "üöÄ Capta√ß√£o e Marketing": [ "Publicar um 'caso de sucesso' an√≥nimo (ex: 'aluno avan√ßou 2 anos escolares em 1') nas redes sociais.", "Entrar em contato com uma escola parceira para agendar uma visita ou evento conjunto.", "Analisar os dados dos √∫ltimos 10 novos alunos para identificar o principal canal de capta√ß√£o (indica√ß√£o, fachada, etc.).", "Gravar um v√≠deo curto (1 min) para o Instagram com uma dica de estudo para os pais." ]
        };
        let html = '';
        for (const category in actions) {
            html += `<h3>${category}</h3>`;
            actions[category].forEach(actionText => {
                html += `<label class="action-item"><input type="checkbox" class="action-checkbox"> <span>${actionText}</span></label>`;
            });
        }
        html += `<div class="button-container"><button id="add-selected-actions-btn" class="btn">Adicionar Selecionadas ao Dia</button></div>`;
        this.elements.actionBankContent.innerHTML = html;
        document.getElementById('add-selected-actions-btn').addEventListener('click', () => {
            const selectedActions = this.elements.actionBankContent.querySelectorAll('.action-checkbox:checked');
            selectedActions.forEach(checkbox => {
                const actionText = checkbox.nextElementSibling.textContent;
                this.addTodoItem(actionText);
                checkbox.checked = false;
            });
        });
    },

    populateMaterialSelect() {
        const materiais = ["Matem√°tica 7A", "Matem√°tica 6A", "Matem√°tica 5A", "Matem√°tica 4A", "Matem√°tica 3A", "Matem√°tica 2A", "Matem√°tica A", "Matem√°tica B", "Matem√°tica C", "Matem√°tica D", "Matem√°tica E", "Matem√°tica F", "Matem√°tica G", "Matem√°tica H", "Matem√°tica I", "Matem√°tica J", "Matem√°tica K", "Matem√°tica L", "Matem√°tica M", "Matem√°tica N", "Matem√°tica O", "Portugu√™s 7A", "Portugu√™s 6A", "Portugu√™s 5A", "Portugu√™s 4A", "Portugu√™s 3A", "Portugu√™s 2A", "Portugu√™s AI", "Portugu√™s AII", "Portugu√™s BI", "Portugu√™s BII", "Portugu√™s CI", "Portugu√™s CII", "Portugu√™s D", "Portugu√™s E", "Portugu√™s F", "Portugu√™s G", "Portugu√™s H", "Portugu√™s I", "Ingl√™s 5A", "Ingl√™s 4A", "Ingl√™s 3A", "Ingl√™s 2A", "Ingl√™s A", "Ingl√™s B", "Ingl√™s C", "Ingl√™s D", "Ingl√™s E", "Ingl√™s F", "Ingl√™s G", "Ingl√™s H", "Ingl√™s I", "Ingl√™s J", "Ingl√™s K", "Ingl√™s L", "Ingl√™s M", "Ingl√™s N", "Ingl√™s O"];
        this.elements.materialSelect.innerHTML = materiais.map(m => `<option value="${m.replace(/\s/g, '_')}">${m}</option>`).join('');
    },

    async loadInventory() {
        const inventoryData = await this.fetchData('inventario', 'estoque');
        this.state.inventory = inventoryData?.materiais || {};
        this.renderInventory();
    },
    
    renderInventory() {
        this.elements.inventoryTbody.innerHTML = '<tr><td colspan="3">Nenhum material no estoque.</td></tr>';
        const sortedMaterials = Object.keys(this.state.inventory).sort();
        if (sortedMaterials.length > 0) {
            let hasStock = false;
            let html = '';
            for (const materialId of sortedMaterials) {
                const item = this.state.inventory[materialId];
                const qty = item.qty || 0;
                if (qty > 0) {
                   hasStock = true;
                   const fileLink = item.fileUrl ? `<a href="${item.fileUrl}" target="_blank">Ver Ficheiro</a>` : 'Nenhum';
                   html += `<tr><td>${materialId.replace(/_/g, ' ')}</td><td>${qty}</td><td>${fileLink}</td></tr>`;
                }
            }
            if (hasStock) { this.elements.inventoryTbody.innerHTML = html; }
        }
    },

    async updateStock(action) {
        const materialId = this.elements.materialSelect.value;
        const qty = parseInt(this.elements.materialQty.value, 10);
        if (!materialId || isNaN(qty) || qty <= 0) { alert("Selecione um material e insira uma quantidade v√°lida."); return; }
        this.state.inventory[materialId] = this.state.inventory[materialId] || { qty: 0 };
        const currentQty = this.state.inventory[materialId].qty;
        if (action === 'remove' && currentQty < qty) { alert(`N√£o √© poss√≠vel dar baixa em ${qty} unidades. Estoque atual: ${currentQty}.`); return; }
        this.state.inventory[materialId].qty = (action === 'add') ? currentQty + qty : currentQty - qty;
        await this.saveData('inventario', 'estoque', { materiais: this.state.inventory });
        this.renderInventory();
    },
    
    openUploadWidget() {
        const materialId = this.elements.materialSelect.value;
        if (!materialId) { alert("Selecione um material para anexar um ficheiro."); return; }
        if (!cloudinaryConfig || !cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) {
            alert("ERRO: As chaves do Cloudinary n√£o est√£o configuradas no ficheiro js/config.js.");
            return;
        }
        const uploadWidget = cloudinary.createUploadWidget({
            cloudName: cloudinaryConfig.cloudName, uploadPreset: cloudinaryConfig.uploadPreset,
            folder: `${this.state.userId}/inventario`, tags: [this.state.userId, 'inventario', materialId]
        }, (error, result) => {
            if (!error && result && result.event === "success") { this.saveFileUrlToInventory(materialId, result.info.secure_url); }
        });
        uploadWidget.open();
    },

    async saveFileUrlToInventory(materialId, fileUrl) {
        this.state.inventory[materialId] = this.state.inventory[materialId] || { qty: 0 };
        this.state.inventory[materialId].fileUrl = fileUrl;
        await this.saveData('inventario', 'estoque', { materiais: this.state.inventory });
        this.renderInventory();
        alert(`Ficheiro anexado ao material ${materialId.replace(/_/g, ' ')} com sucesso!`);
    }
};

App.init(); // O init ser√° chamado pelo auth.js
